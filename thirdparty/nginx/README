Description
-----------

This directory contains the files needed to build Nginx customized with
Zimbra modifications and modules.

The pristine source is downloaded using the `make getsrc` command which
does the following:

- Downloads the released tarball from https://nginx.org/download using the
  version defined in the `packages/versions.def` file in the parent directory.
- Applies the Zimbra patch `zimbra-1.17.9.patch` to the source

- Tar gzips the modified source and places it `build/<platform>/src`

Note: The Nginx source SHOULD NOT be checked in to this repository.
      The intent is all changes are made in https://github.com/Zimbra/nginx .
      Please see `Updating the patch` below for how to update and generate the patch file being applied.

Contents
--------

  ./docs/
    contains instructions for building, configuring, and running nginx-zimbra
    Please see the `Building` section below for how to build.

  ./extras/
    contains a sample nginx configuration file suitable for use with zimbra
    (old and not up to date)

  ./patches/
    contains the patch for Nginx 1.17.9

Building
--------

The Makefile targets to build are:

 - getsrc: Downloads the unmodified Nginx source code and patches it using the
           patches/zimbra-1.17.9.patch file.
 - build : Builds the deb/rpm file depending on build platform.

Building nginx is done as follows (Ubuntu example):

    cd /work/packages/thirdparty/nginx/

    build@dfd86d090e02:/work/packages/thirdparty/nginx$ make getsrc build
    sudo apt-get --assume-yes --verbose-versions install zimbra-base zimbra-openssl-dev zimbra-cyrus-sasl-dev
    Reading package lists... Done
    Building dependency tree
    Reading state information... Done
    zimbra-base is already the newest version (1.0.2-1zimbra8.7b1.16.04).
    zimbra-base set to manually installed.
    ...

In order to retrieve all the required Zimbra packages for building you may need to create '/etc/apt/sources.list.d/zimbra.list' with the following contents:

    deb  [arch=amd64] https://repo.zimbra.com/apt/87 xenial zimbra
    deb  [arch=amd64] https://repo.zimbra.com/apt/90 xenial zimbra
    deb-src [arch=amd64] https://repo.zimbra.com/apt/87 xenial zimbra
    deb  [arch=amd64] https://repo.zimbra.com/apt/90-ne xenial zimbra

If you encounter an error about a GPG key you may import it in the following fashion:

    W: GPG error: https://repo.zimbra.com/apt/87 xenial InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 5234D2B73B6996C7

Importing the GPG key:

    sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 5234D2B73B6996C7

Updating the patch
------------------

All source code adjustments should be done in the Zimbra/nginx repository.
Repository URL: https://github.com/Zimbra/nginx

Once the changes needed are implemented check in all changes to your branch.

The diff is generated directly by git as follows:

    git diff release-1.17.9 > zimbra.patch

You then will need to delete the portion that adds the `configure` script in the patch file.
The patch *MUST* apply cleanly without user interaction to approve anything.
Test applying this to a clean checked out copy of the version of nginx you are basing your patch on before checking it in.

Once you are satisfied with your patch update the `packages/versions.def` file in the parent directory with the NGINX_VERSION and also update the Makefile to ensure the `getsrc` target applies your patch.

At that point you should be able to `make build` and create debian / rpm packages containing your patched version of Nginx.

Building with Docker
--------------------

In order to facilitate development a Docker image was created containing
the relevant Zimbra files to assist with compilation.
It is found in the `docker` directory at the root of this repository.

    pwd
    /home/ubuntu/packages

Building the docker image is accomplished with the following command:

    docker build -t zimbra/thirdparty:develop ./docker
    docker build -t zimbra/thirdparty:develop --build-arg=VERSION=16.04 ./docker

In order to allow all the helper scripts and files to be found the directory containing the `packages` and `zimbra-package-stub` directories should be mounted in to the container.

Once the image is built you can run it as follows from the parent directory of the `packages` repository:

    ls /home/ubuntu/zimbra
    packages

    docker run -it --rm -v /home/ubuntu/zimbra:/work zimbra/third-party:develop bash

Building nginx is done as follows:

    cd /work/packages/thirdparty/nginx/

    build@dfd86d090e02:/work/packages/thirdparty/nginx$ make getsrc build
    sudo apt-get --assume-yes --verbose-versions install zimbra-base zimbra-openssl-dev zimbra-cyrus-sasl-dev
    Reading package lists... Done
    Building dependency tree
    Reading state information... Done
    zimbra-base is already the newest version (1.0.2-1zimbra8.7b1.16.04).
    zimbra-base set to manually installed.
    ...
